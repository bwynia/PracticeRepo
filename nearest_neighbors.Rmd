---
title: "nearest_neighbors"
author: "Benjamin S. Wynia"
date: "September 30, 2017"
output: html_document
---
# Load Data
```{r}
properties <- read.csv("properties_2016.csv")

```

# Build Nearest Neighbors Dataset
```{r}
# New dataset with just the parcelid, longitude, and latitude
nn_dataset <- data.frame(properties$parcelid, properties$longitude, properties$latitude)
colnames(nn_dataset) <- c("parcelid","x","y")
# filter to only include complete cases (should be very few missing one of those variables)
nn_dataset <- nn_dataset[complete.cases(nn_dataset), ]

```

# Calculate Nearest Neighbors (10 point trial run)
```{r}
# this uses nn2 and a kd-tree to find nearest neighbors
neighbors_test <- nn2(data=nn_dataset[1:10,2:3], k=4, treetype ="kd")[[1]]
colnames(neighbors_test) <- c("Point","Neighbor 1","Neighbor 2","Neighbor 3")

```

# Test plot the trial run of Nearest Neighbors to Confirm 

```{r}
point_names <- as.vector(neighbors_test[1:10,1])

# Plot the first 10 points
plot <- ggplot(nn_dataset[1:10,], aes(nn_dataset[1:10,2],nn_dataset[1:10,3])) + geom_point() + geom_text(aes(label=point_names), hjust = 1, vjust = 1)
plot

# you can individually go through each of the 20 points and check that the algorithm identifies the 3 nearest neighbors
# I've selected three representative samples below
neighbors_test[1,]
neighbors_test[5,]
neighbors_test[10,]

```

# Test a trial run of the rows to parcelid swapping code
```{r}
# create empty vectors to store each parcel id
point_test <- as.vector(rep(0,nrow(nn_dataset[1:10,])))
neighbor_1_test  <- as.vector(rep(0,nrow(nn_dataset[1:10,])))
neighbor_2_test  <- as.vector(rep(0,nrow(nn_dataset[1:10,])))
neighbor_3_test  <- as.vector(rep(0,nrow(nn_dataset[1:10,])))

# iterate across the dataset, swapping parcelid for row number from the "neighbors" dataset
for (i in 1:nrow(neighbors_test)) {
  point_test[i] <- nn_dataset[i,1]
  neighbor_1_test[i] <- nn_dataset$parcelid[neighbors_test[i,2]]
  neighbor_2_test[i] <- nn_dataset$parcelid[neighbors_test[i,3]]
  neighbor_3_test[i] <- nn_dataset$parcelid[neighbors_test[i,4]]
}
neighborhood_test <- data.frame(point_test,neighbor_1_test, neighbor_2_test, neighbor_3_test)
colnames(neighborhood_test) <- c("parcelid","Neighbor 1","Neighbor 2","Neighbor 3")
neighborhood_test
```

# Plot the resulting test frame to ensure that neighbors are being correctly tagged with parcel_IDs

```{r}
point_names2 <- as.vector(neighborhood_test[1:10,1])
plot2 <- ggplot(nn_dataset[1:10,], aes(nn_dataset[1:10,2],nn_dataset[1:10,3])) + geom_point() + geom_text(aes(label=point_names2), hjust = 1, vjust = 2)
plot2
neighborhood_test[4,]
neighborhood_test[7,]
```

# Run the Nearest Neighbors algorithm on the entire dataset
The output of this is a dataframe with four columns. Column 1 is the first row of the nn_dataset, column 2, 3, and 4 are the "row numbers" of the nearest neighbors.
```{r}
neighbors <- nn2(data=nn_dataset[,2:3], k=4, treetype ="kd")[[1]]
colnames(neighbors) <- c("Point","Neighbor 1","Neighbor 2","Neighbor 3")
```

# Swap the row numbers for parcel_ids (Primary key for dataset)
We have to take the row numbers of the nearest neighbor, and plug that back into the original dataset to get the parcelid. This takes a couple minutes to run, and there is probably a better method than a "for" loop.

```{r}

# create empty vectors to store each parcel id
point <- as.vector(rep(0,nrow(nn_dataset)))
neighbor_1 <- as.vector(rep(0,nrow(nn_dataset)))
neighbor_2 <- as.vector(rep(0,nrow(nn_dataset)))
neighbor_3 <- as.vector(rep(0,nrow(nn_dataset)))

# iterate across the dataset, swapping parcelid for row number from the "neighbors" dataset
for (i in 1:nrow(neighbors)) {
  point[i] <- nn_dataset[i,1]
  neighbor_1[i] <- nn_dataset$parcelid[neighbors[i,2]]
  neighbor_2[i] <- nn_dataset$parcelid[neighbors[i,3]]
  neighbor_3[i] <- nn_dataset$parcelid[neighbors[i,4]]
}
neighborhood <- data.frame(point,neighbor_1, neighbor_2, neighbor_3)
colnames(neighborhood) <- c("parcelid","Neighbor 1","Neighbor 2","Neighbor 3")

```

neighborhood is the dataset which has each parcelid in column 1 with the parcelid's of the three closest neighbors in columns 1, 2, and 3. We can use it for any queries where we want to test location as a determining factor. 
